clc;clear;
mQ=0.55;g=9.8;
Ixx=0.0023;
Iyy=0.0028;
Izz=0.0046;
inertia=[Ixx,0,0;0,Iyy,0;0,0,Izz];
%%
phi0 = 0;
dphi0 = 0;
theta0 = 0;
dtheta0 = 0;
psi0 = 0;
dpsi0 = 0;

Ft0 = mQ*g;
Mx0 = 0;
My0 = 0;
Mz0 = 0;

% Generalized Force 
M = [mQ,0,0,0,0,0;0,mQ,0,0,0,0;0,0,mQ,0,0,0;0,0,0,Ixx,0,(-1).*Ixx.* ...
  sin(theta0);0,0,0,0,Iyy.*cos(phi0).^2+Izz.*sin(phi0).^2,(Iyy+(-1) ...
  .*Izz).*cos(phi0).*cos(theta0).*sin(phi0);0,0,0,(-1).*Ixx.*sin( ...
  theta0),(Iyy+(-1).*Izz).*cos(phi0).*cos(theta0).*sin(phi0),cos( ...
  theta0).^2.*(Izz.*cos(phi0).^2+Iyy.*sin(phi0).^2)+Ixx.*sin(theta0) ...
  .^2];
%%
DfDX = [0,0,0,0,0,0,Ft0.*(cos(phi0).*sin(psi0)+(-1).*cos(psi0).*sin(phi0) ...
  .*sin(theta0)),0,Ft0.*cos(phi0).*cos(psi0).*cos(theta0),0,Ft0.*( ...
  cos(psi0).*sin(phi0)+(-1).*cos(phi0).*sin(psi0).*sin(theta0)),0;0, ...
  0,0,0,0,0,(-1).*Ft0.*(cos(phi0).*cos(psi0)+sin(phi0).*sin(psi0).* ...
  sin(theta0)),0,Ft0.*cos(phi0).*cos(theta0).*sin(psi0),0,Ft0.*(sin( ...
  phi0).*sin(psi0)+cos(phi0).*cos(psi0).*sin(theta0)),0;0,0,0,0,0,0, ...
  (-1).*Ft0.*cos(theta0).*sin(phi0),0,(-1).*Ft0.*cos(phi0).*sin( ...
  theta0),0,0,0;0,0,0,0,0,0,(1/2).*(Iyy+(-1).*Izz).*(cos(2.*phi0).*( ...
  dpsi0.^2+(-2).*dtheta0.^2+dpsi0.^2.*cos(2.*theta0))+(-4).*dpsi0.* ...
  dtheta0.*cos(theta0).*sin(2.*phi0)),0,dpsi0.*((-1).*dtheta0.*Ixx+( ...
  -1).*(Iyy+(-1).*Izz).*(dtheta0.*cos(2.*phi0)+dpsi0.*cos(theta0).* ...
  sin(2.*phi0))).*sin(theta0),dpsi0.*(Ixx+(Iyy+(-1).*Izz).*cos(2.* ...
  phi0)).*cos(theta0)+dtheta0.*((-1).*Iyy+Izz).*sin(2.*phi0),0,cos( ...
  theta0).*(dtheta0.*Ixx+(Iyy+(-1).*Izz).*(dtheta0.*cos(2.*phi0)+ ...
  dpsi0.*cos(theta0).*sin(2.*phi0)));0,0,0,0,0,0,(-1).*My0.*sin( ...
  phi0)+2.*dphi0.*(Iyy+(-1).*Izz).*(dtheta0.*cos(2.*phi0)+dpsi0.* ...
  cos(theta0).*sin(2.*phi0))+cos(phi0).*((-1).*Mz0+dpsi0.^2.*((-1).* ...
  Iyy+Izz).*sin(phi0).*sin(2.*theta0)),(-1).*dpsi0.*(Ixx+(Iyy+(-1).* ...
  Izz).*cos(2.*phi0)).*cos(theta0)+dtheta0.*(Iyy+(-1).*Izz).*sin(2.* ...
  phi0),(1/2).*dpsi0.*(dpsi0.*(2.*Ixx+(-1).*Iyy+(-1).*Izz+(Iyy+(-1) ...
  .*Izz).*cos(2.*phi0)).*cos(2.*theta0)+2.*dphi0.*(Ixx+(Iyy+(-1).* ...
  Izz).*cos(2.*phi0)).*sin(theta0)),dphi0.*(Iyy+(-1).*Izz).*sin(2.* ...
  phi0),0,cos(theta0).*((-1).*dpsi0.*(Iyy+Izz).*sin(theta0)+(-1).* ...
  Ixx.*(dphi0+(-2).*dpsi0.*sin(theta0))+(Iyy+(-1).*Izz).*cos(2.* ...
  phi0).*((-1).*dphi0+dpsi0.*sin(theta0)));0,0,0,0,0,0,My0.*cos( ...
  phi0).*cos(theta0)+(-1).*(Iyy+(-1).*Izz).*cos(2.*phi0).*(2.* ...
  dphi0.*dpsi0.*cos(theta0).^2+(-1).*dtheta0.^2.*sin(theta0))+cos( ...
  theta0).*((-1).*Mz0.*sin(phi0)+2.*dtheta0.*(Iyy+(-1).*Izz).*sin( ...
  2.*phi0).*(dphi0+dpsi0.*sin(theta0))),cos(theta0).*(dtheta0.*Ixx+( ...
  -1).*(Iyy+(-1).*Izz).*(dtheta0.*cos(2.*phi0)+dpsi0.*cos(theta0).* ...
  sin(2.*phi0))),dpsi0.*dtheta0.*((-2).*Ixx+Iyy+Izz+((-1).*Iyy+Izz) ...
  .*cos(2.*phi0)).*cos(2.*theta0)+(-1).*(Mz0.*cos(phi0)+dphi0.* ...
  dtheta0.*(Ixx+((-1).*Iyy+Izz).*cos(2.*phi0))+My0.*sin(phi0)).*sin( ...
  theta0)+(1/2).*cos(theta0).*((-2).*Mx0+(Iyy+(-1).*Izz).*sin(2.* ...
  phi0).*(dtheta0.^2+4.*dphi0.*dpsi0.*sin(theta0))),dtheta0.*(Iyy+( ...
  -1).*Izz).*sin(2.*phi0).*sin(theta0)+cos(theta0).*(dphi0.*Ixx+ ...
  dpsi0.*((-2).*Ixx+Iyy+Izz).*sin(theta0)+(-1).*(Iyy+(-1).*Izz).* ...
  cos(2.*phi0).*(dphi0+dpsi0.*sin(theta0))),0,2.*cos(theta0).*( ...
  dphi0.*((-1).*Iyy+Izz).*cos(phi0).*cos(theta0).*sin(phi0)+ ...
  dtheta0.*((-1).*Ixx+Izz.*cos(phi0).^2+Iyy.*sin(phi0).^2).*sin( ...
  theta0))];
DfDU = [sin(phi0).*sin(psi0)+cos(phi0).*cos(psi0).*sin(theta0),0,0,0;(-1) ...
  .*cos(psi0).*sin(phi0)+cos(phi0).*sin(psi0).*sin(theta0),0,0,0; ...
  cos(phi0).*cos(theta0),0,0,0;0,1,0,0;0,0,cos(phi0),(-1).*sin(phi0) ...
  ;0,(-1).*sin(theta0),cos(theta0).*sin(phi0),cos(phi0).*cos(theta0) ...
  ];
%%

%%
A_temp = M\DfDX;
B_temp = M\DfDU;

A = [0,1,0,0,0,0,0,0,0,0,0,0;...
    A_temp(1,:);...
    0,0,0,1,0,0,0,0,0,0,0,0;...
    A_temp(2,:);...
    0,0,0,0,0,1,0,0,0,0,0,0;...
    A_temp(3,:);...
    0,0,0,0,0,0,0,1,0,0,0,0;...
    A_temp(4,:);...
    0,0,0,0,0,0,0,0,0,1,0,0;...
    A_temp(5,:);...
    0,0,0,0,0,0,0,0,0,0,0,1;...
    A_temp(6,:);...
    ];

B = [zeros(1,4);...
    B_temp(1,:);...
    zeros(1,4);...
    B_temp(2,:);...
    zeros(1,4);...
    B_temp(3,:);...
    zeros(1,4);...
    B_temp(4,:);...
    zeros(1,4);...
    B_temp(5,:);...
    zeros(1,4);...
    B_temp(6,:);
    ];

C = eye(12);
D = zeros(12,4);
